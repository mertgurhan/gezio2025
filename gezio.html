<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gezio - TÃ¼rkiye KeÅŸif Rehberi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font for better aesthetics -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d9488; /* Teal 600 - Akdeniz rengi */
            --secondary-color: #fbbf24; /* Amber 400 - GÃ¼neÅŸ rengi */
            --background-color: #f3f4f6; /* Gray 100 */
            --card-bg: #ffffff;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
        }
        /* Custom scrollbar for aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: var(--background-color); }

        .rating-star {
            color: var(--secondary-color); /* Amber/SarÄ± yÄ±ldÄ±zlar */
        }
        .place-card {
            transition: all 0.3s ease;
        }
        .place-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Harita kapsayÄ±cÄ±sÄ± iÃ§in minimum boyut */
        #detail-map {
            height: 300px;
            width: 100%;
        }
        .city-card {
            background-color: #ffffff;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .city-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 2px solid var(--primary-color);
        }
        .city-card.disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        .city-card.disabled:hover {
             transform: none;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
             border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Header / Navigation Bar -->
    <header class="bg-white shadow-lg sticky top-0 z-10 hidden" id="main-header">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <!-- Åehir DeÄŸiÅŸtirme Butonu (Yeni Modal'Ä± aÃ§ar) -->
                <button onclick="showCitySelectionModal()" class="flex items-center p-2 border border-gray-300 rounded-lg text-base font-semibold mr-4 bg-gray-50 hover:bg-gray-100 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1 text-teal-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zm-5 8a5 5 0 015-5c1.455 0 2.802.483 3.903 1.298l-7.794 7.794A5 5 0 015 10zm10 0a5 5 0 00-5-5c-1.455 0-2.802.483-3.903 1.298l7.794 7.794A5 5 0 0015 10z" clip-rule="evenodd" />
                    </svg>
                    <span id="current-city-display">Fethiye</span> DeÄŸiÅŸtir
                </button>
                <h1 class="text-2xl font-extrabold text-gray-900 flex items-center">
                    <!-- KeÅŸif Ä°konu (Compass) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-teal-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Gezio
                </h1>
            </div>
            
            <!-- Auth Butonu -->
            <button onclick="handleAuthClick()" id="auth-button" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-full shadow-md transition duration-300">
                GiriÅŸ Yap / Ãœye Ol
            </button>
            <span id="user-info" class="hidden text-sm font-medium text-gray-600"></span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 hidden" id="main-content">

        <!-- Search Bar and Filters -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <!-- BaÅŸlÄ±k dinamik olarak selectCity fonksiyonunda doldurulacak -->
            <h2 id="search-bar-title" class="text-xl font-semibold text-gray-800 mb-4">Fethiye'de Nereyi KeÅŸfetmek Ä°stersiniz?</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- Placeholder dinamik olarak updateSearchAndFilters'ta doldurulacak -->
                <input type="text" id="search-input" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150" onkeyup="filterPlaces()">
                <!-- Ä°Ã§erik dinamik olarak updateSearchAndFilters'ta doldurulacak -->
                <select id="category-filter" class="p-3 border border-gray-300 rounded-lg w-full sm:w-48 focus:ring-teal-500 focus:border-teal-500 transition duration-150" onchange="filterPlaces()">
                    <!-- Dinamik olarak yÃ¼klenecek -->
                </select>
            </div>
            <!-- Gemini Destekli Gezi PlanÄ± OluÅŸturucu -->
            <button onclick="generateTripPlan()" id="plan-button" class="mt-4 w-full sm:w-auto px-6 py-2 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg shadow-md transition duration-300 disabled:opacity-50" disabled>
                âœ¨ Bir GÃ¼nlÃ¼k Seyahat PlanÄ± OluÅŸtur
            </button>
        </div>

        <!-- Place Listing Section -->
        <section id="place-list-section" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Yer KartlarÄ± Buraya Eklenecek -->
        </section>
        
    </main>

    <!-- 1. ÅEHÄ°R SEÃ‡Ä°M MODALI (BaÅŸlangÄ±Ã§ta AÃ§Ä±k) -->
    <div id="city-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto p-8">
            <h2 class="text-3xl font-extrabold text-teal-600 mb-6 text-center">TÃ¼rkiye'de KeÅŸfe Nereden BaÅŸlayalÄ±m?</h2>
            <p class="text-gray-600 text-center mb-8">LÃ¼tfen bir ÅŸehir seÃ§in. Åu an sadece Fethiye ve Ä°stanbul aktif durumdadÄ±r.</p>

            <div id="city-selection-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Åehir KartlarÄ± Dinamik Olarak Buraya Eklenecek -->
            </div>
        </div>
    </div>
    <!-- Åehir SeÃ§im ModalÄ± Son -->

    <!-- 2. Detay Modal (Unchanged) -->
    <div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform transition-all">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="detail-title" class="text-3xl font-bold text-gray-900"></h2>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-700 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <img id="detail-image" class="w-full h-64 object-cover rounded-lg mb-4" alt="Yer Resmi">

                <div id="detail-rating-container" class="flex items-center space-x-2 mb-4">
                    <!-- Puan YÄ±ldÄ±zlarÄ± Buraya Eklenecek -->
                </div>
                
                <div class="flex items-center space-x-4 mb-4">
                    <!-- Yapay Zeka Ã–zeti Butonu -->
                    <button onclick="summarizePlaceDescription()" id="summary-button" class="px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg shadow transition duration-300 disabled:opacity-50" disabled>
                        âœ¨ AÃ§Ä±klamayÄ± Ã–zetle
                    </button>
                    <!-- Sesli AnlatÄ±m Butonu -->
                    <button onclick="readDescriptionAloud()" id="tts-button" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow transition duration-300 disabled:opacity-50" disabled>
                        ğŸ”Š Dinle
                    </button>
                </div>

                <div id="summary-loading-indicator" class="text-sm text-blue-500 italic mb-4 hidden">
                    Ã–zet oluÅŸturuluyor...
                </div>
                <div id="tts-loading-indicator" class="text-sm text-blue-500 italic mb-4 hidden">
                    Ses dosyasÄ± hazÄ±rlanÄ±yor...
                </div>
                
                <!-- DetaylÄ± AÃ§Ä±klama / Ã–zetin GÃ¶sterileceÄŸi Alan -->
                <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">DetaylÄ± AÃ§Ä±klama</h3>
                <p id="detail-description" class="text-gray-700 mb-6 whitespace-pre-wrap"></p>


                <!-- Harita AlanÄ± (OpenStreetMap veya Basit Konum Bilgisi) -->
                <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">Konum Bilgisi</h3>
                <!-- Telifsiz, basit harita placeholder'Ä±. CanlÄ± bir harita iÃ§in daha sonra API entegrasyonu gerekir. -->
                <div id="detail-map" class="bg-gray-200 rounded-lg flex items-center justify-center text-gray-500 italic mb-6">
                    Harita AlanÄ± (Bu aÅŸamada sadece yer tutucu. Ä°leride Google Maps veya Leaflet entegrasyonu yapÄ±lacaktÄ±r.)
                </div>
                
                <!-- Yorumlar BÃ¶lÃ¼mÃ¼ (MVP'de statik veya sahte verilerle gÃ¶sterilecek) -->
                <h3 class="text-xl font-semibold text-teal-600 mb-3 border-b pb-2">KullanÄ±cÄ± YorumlarÄ± (<span id="review-count">0</span>)</h3>
                <div id="reviews-container" class="space-y-4">
                    <p id="no-reviews" class="text-gray-500">HenÃ¼z yorum yok. Ä°lk yorumu siz yapÄ±n!</p>
                    <!-- Yorumlar dinamik olarak buraya eklenecek -->
                </div>

                <!-- Yorum Ekleme Formu (GiriÅŸ YapÄ±lÄ±nca GÃ¶rÃ¼nÃ¼r Olacak) -->
                <div id="review-form-container" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h4 class="font-semibold mb-2">Yorumunuzu Ekleyin</h4>
                    <textarea id="review-text" rows="3" class="w-full p-2 border rounded-lg mb-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Deneyiminizi anlatÄ±n..."></textarea>
                    <div class="flex items-center mb-2">
                        <span class="mr-2">PuanÄ±nÄ±z:</span>
                        <div id="rating-input" class="flex space-x-1 cursor-pointer">
                            <!-- 5 adet boÅŸ yÄ±ldÄ±z SVG'si -->
                            <svg data-rating="1" class="h-6 w-6 text-gray-300 hover:text-yellow-500 transition duration-150" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.031a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.031a1 1 0 00-1.175 0l-2.817 2.031c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            <svg data-rating="2" class="h-6 w-6 text-gray-300 hover:text-yellow-500 transition duration-150" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.031a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.031a1 1 0 00-1.175 0l-2.817 2.031c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            <svg data-rating="3" class="h-6 w-6 text-gray-300 hover:text-yellow-500 transition duration-150" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.031a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.031a1 1 0 00-1.175 0l-2.817 2.031c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            <svg data-rating="4" class="h-6 w-6 text-gray-300 hover:text-yellow-500 transition duration-150" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.031a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.031a1 1 0 00-1.175 0l-2.817 2.031c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            <svg data-rating="5" class="h-6 w-6 text-gray-300 hover:text-yellow-500 transition duration-150" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.031a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.031a1 1 0 00-1.175 0l-2.817 2.031c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                        </div>
                    </div>
                    <button onclick="submitReview()" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 w-full">Yorumu GÃ¶nder</button>
                </div>

                <div id="auth-warning" class="mt-6 p-4 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg text-sm text-center">
                    Yorum ekleyebilmek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n veya Ã¼ye olun.
                </div>

            </div>
        </div>
    </div>
    
    <!-- 3. Trip Plan Modal (Unchanged) -->
    <div id="trip-plan-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto transform transition-all p-6">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-2xl font-bold text-gray-900">âœ¨ Bir GÃ¼nlÃ¼k Seyahat PlanÄ±</h2>
                <button onclick="closeTripPlanModal()" class="text-gray-400 hover:text-gray-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="trip-plan-content" class="text-gray-700 whitespace-pre-wrap">
                <!-- Plan buraya eklenecek -->
            </div>
            <div id="trip-plan-loading" class="text-center py-8">
                <svg class="animate-spin h-8 w-8 text-teal-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-teal-600">Seyahat planÄ±nÄ±z yapay zeka tarafÄ±ndan oluÅŸturuluyor...</p>
            </div>
        </div>
    </div>
    
    <!-- 4. KULLANICI GÄ°RÄ°Å/KAYIT MODALI (Yeni) -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-start mb-4">
                <h2 id="auth-title" class="text-2xl font-bold text-teal-600">GiriÅŸ Yap</h2>
                <button onclick="closeAuthModal()" class="text-gray-400 hover:text-gray-700 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert">
                <span id="auth-error-message" class="block sm:inline"></span>
            </div>

            <input type="email" id="auth-email" placeholder="E-posta Adresi" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-teal-500 focus:border-teal-500">
            <input type="password" id="auth-password" placeholder="Åifre" class="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-teal-500 focus:border-teal-500">
            
            <button onclick="authenticateUser()" id="auth-action-button" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-300 w-full mb-3">
                GiriÅŸ Yap
            </button>

            <button onclick="toggleAuthMode()" id="auth-toggle-button" class="text-sm text-teal-600 hover:text-teal-800 w-full text-center">
                HesabÄ±nÄ±z yok mu? Yeni hesap oluÅŸturun.
            </button>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12 py-6 hidden" id="main-footer">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p>&copy; 2025 Gezio (ArtÄ±rÄ±mlÄ± Model MVP). TÃ¼m HaklarÄ± SaklÄ±dÄ±r.</p>
        </div>
    </footer>

    <!-- Firebase SDK Imports (Module setup required for Canvas environment) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, where, getDocs, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentCityId = 'fethiye'; // VarsayÄ±lan ÅŸehir
        let authMode = 'login'; // 'login' veya 'register'

        // API Key (Canvas tarafÄ±ndan otomatik saÄŸlanacak)
        const apiKey = ""; 

        // Firebase Configuration and Initialization
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            setLogLevel('Debug');
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;
                const authButton = document.getElementById('auth-button');
                const userInfoSpan = document.getElementById('user-info');

                // Ã–nce anonim/custom token ile giriÅŸ yapÄ±ldÄ±ysa, kullanÄ±cÄ± nesnesini kullan.
                // Yorum sistemi iÃ§in Ã¶nemli: Sadece geÃ§erli, kalÄ±cÄ± bir AuthUser varsa yoruma izin veriyoruz.
                const isAuthenticated = user && user.email; // Sadece e-posta ile giriÅŸ yapanlar iÃ§in true

                if (isAuthenticated) {
                    userId = user.uid;
                    authButton.textContent = 'Ã‡Ä±kÄ±ÅŸ Yap';
                    authButton.onclick = () => handleAuthClick(true); // Ã‡Ä±kÄ±ÅŸ yap fonksiyonu ata
                    userInfoSpan.classList.remove('hidden');
                    userInfoSpan.textContent = `HoÅŸ geldiniz, ${user.email.split('@')[0]}`;
                } else if (user) { 
                    // Anonim kullanÄ±cÄ± (Firebase'e sadece veri yazmak iÃ§in gerekli)
                    userId = user.uid;
                    authButton.textContent = 'GiriÅŸ Yap / Ãœye Ol';
                    authButton.onclick = () => handleAuthClick(false);
                    userInfoSpan.classList.add('hidden');
                } else {
                    userId = null;
                    authButton.textContent = 'GiriÅŸ Yap / Ãœye Ol';
                    authButton.onclick = () => handleAuthClick(false);
                    userInfoSpan.classList.add('hidden');
                }
                
                // Yorum Formu GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ Kontrol Et (YalnÄ±zca KalÄ±cÄ± KullanÄ±cÄ±lar iÃ§in)
                const reviewFormContainer = document.getElementById('review-form-container');
                const authWarning = document.getElementById('auth-warning');
                if (reviewFormContainer && authWarning) {
                    if (isAuthenticated) {
                        reviewFormContainer.classList.remove('hidden');
                        authWarning.classList.add('hidden');
                    } else {
                        reviewFormContainer.classList.add('hidden');
                        authWarning.classList.remove('hidden');
                    }
                }
                
                // Auth tamamlanÄ±nca verileri yÃ¼kle
                if (window.loadData) {
                    window.loadData();
                }
            });

            // Initial sign-in attempt (Anonim veya Custom Token ile arka plan yetkilendirmesi)
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token ile giriÅŸ baÅŸarÄ±sÄ±z:", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
        } else {
            console.warn("Firebase yapÄ±landÄ±rmasÄ± eksik. Yorum ve puanlama Ã§alÄ±ÅŸmayacaktÄ±r.");
            isAuthReady = true; // Mock data iÃ§in hazÄ±r kabul et
            if (window.loadData) {
                window.loadData();
            }
        }
        
        // --- Auth Modal Functions ---
        
        window.handleAuthClick = async function(isLoggedIn) {
            if (isLoggedIn) {
                // Ã‡Ä±kÄ±ÅŸ yap
                try {
                    await signOut(auth);
                    // Anonim olarak yeniden giriÅŸ yap (Firestore'a anonim eriÅŸimi korumak iÃ§in)
                    await signInAnonymously(auth);
                    window.alertMessage("BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yaptÄ±nÄ±z.", 'bg-green-100 border-green-400 text-green-700');
                } catch (error) {
                    console.error("Ã‡Ä±kÄ±ÅŸ yaparken hata:", error);
                    window.alertMessage("Ã‡Ä±kÄ±ÅŸ yaparken bir hata oluÅŸtu.", 'bg-red-100 border-red-400 text-red-700');
                }
            } else {
                // GiriÅŸ/KayÄ±t ModalÄ±nÄ± gÃ¶ster
                showAuthModal();
            }
        }

        window.showAuthModal = function() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('auth-modal').classList.add('flex');
            // Modu varsayÄ±lan olarak "GiriÅŸ Yap"a sÄ±fÄ±rla
            authMode = 'login';
            updateAuthModalUI();
            document.getElementById('auth-error').classList.add('hidden'); // Hata mesajÄ±nÄ± temizle
        }

        window.closeAuthModal = function() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('auth-modal').classList.remove('flex');
        }

        window.toggleAuthMode = function() {
            authMode = authMode === 'login' ? 'register' : 'login';
            updateAuthModalUI();
        }

        function updateAuthModalUI() {
            const title = document.getElementById('auth-title');
            const actionButton = document.getElementById('auth-action-button');
            const toggleButton = document.getElementById('auth-toggle-button');
            
            if (authMode === 'login') {
                title.textContent = 'GiriÅŸ Yap';
                actionButton.textContent = 'GiriÅŸ Yap';
                toggleButton.innerHTML = 'HesabÄ±nÄ±z yok mu? Yeni hesap oluÅŸturun.';
            } else {
                title.textContent = 'KayÄ±t Ol';
                actionButton.textContent = 'Yeni Hesap OluÅŸtur';
                toggleButton.innerHTML = 'Zaten hesabÄ±nÄ±z var mÄ±? GiriÅŸ yapÄ±n.';
            }
        }
        
        window.authenticateUser = async function() {
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            const errorDiv = document.getElementById('auth-error');
            const errorMessageSpan = document.getElementById('auth-error-message');

            errorDiv.classList.add('hidden');
            errorMessageSpan.textContent = '';
            
            if (!email || !password) {
                errorMessageSpan.textContent = 'LÃ¼tfen e-posta ve ÅŸifrenizi girin.';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                if (authMode === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.alertMessage("BaÅŸarÄ±yla giriÅŸ yaptÄ±nÄ±z!", 'bg-green-100 border-green-400 text-green-700');
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                    window.alertMessage("HesabÄ±nÄ±z baÅŸarÄ±yla oluÅŸturuldu ve giriÅŸ yapÄ±ldÄ±!", 'bg-green-100 border-green-400 text-green-700');
                }
                closeAuthModal();
            } catch (error) {
                let displayMessage = 'Bir hata oluÅŸtu. LÃ¼tfen bilgilerinizi kontrol edin.';
                if (error.code === 'auth/user-not-found') {
                    displayMessage = 'Bu e-posta adresine kayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±.';
                } else if (error.code === 'auth/wrong-password') {
                    displayMessage = 'HatalÄ± ÅŸifre girdiniz.';
                } else if (error.code === 'auth/email-already-in-use') {
                    displayMessage = 'Bu e-posta adresi zaten kullanÄ±mda.';
                } else if (error.code === 'auth/weak-password') {
                    displayMessage = 'Åifre en az 6 karakter olmalÄ±dÄ±r.';
                }
                
                errorMessageSpan.textContent = displayMessage;
                errorDiv.classList.remove('hidden');
                console.error("Auth Error:", error);
            }
        }


        // --- Firestore Data Functions (Unchanged) ---

        /**
         * Belirli bir yere ait yorumlarÄ± Firestore'dan dinler.
         * @param {string} placeId 
         */
        window.listenForReviews = (placeId) => {
            if (!isAuthReady || !db || !placeId) return;

            // Ortak/Public veri yolu: /artifacts/{appId}/public/data/reviews
            const reviewsRef = collection(db, 'artifacts', appId, 'public', 'data', 'reviews');
            const q = query(reviewsRef, where("placeId", "==", placeId));
            
            onSnapshot(q, (snapshot) => {
                const reviews = [];
                snapshot.forEach(doc => {
                    reviews.push({ id: doc.id, ...doc.data() });
                });
                renderReviews(reviews);
            }, (error) => {
                console.error("Yorumlar dinlenirken hata oluÅŸtu:", error);
            });
        }

        /**
         * YorumlarÄ± ve puanlarÄ± detay modalÄ±na render eder.
         * @param {Array<Object>} reviews 
         */
        const renderReviews = (reviews) => {
            const container = document.getElementById('reviews-container');
            const countSpan = document.getElementById('review-count');
            container.innerHTML = '';
            countSpan.textContent = reviews.length;

            if (reviews.length === 0) {
                document.getElementById('no-reviews').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-reviews').classList.add('hidden');
            }

            reviews.forEach(review => {
                const reviewElement = document.createElement('div');
                reviewElement.className = 'p-3 bg-white border border-gray-200 rounded-lg shadow-sm';
                reviewElement.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="font-semibold text-gray-800">${review.userName || 'Anonim KullanÄ±cÄ±'}</div>
                        <div class="flex items-center">
                            ${generateStarRating(review.rating)}
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">${review.text}</p>
                `;
                container.appendChild(reviewElement);
            });
        }

        // Yorum gÃ¶nderme (Firebase'i kullanÄ±r)
        window.submitReview = async () => {
            // YORUM EKLEME ZORUNLULUÄU KONTROLÃœ
            if (!auth.currentUser || !auth.currentUser.email) {
                window.alertMessage("Yorum ekleyebilmek iÃ§in lÃ¼tfen giriÅŸ yapÄ±n.", 'bg-red-100 border-red-400 text-red-700');
                showAuthModal(); // GiriÅŸ yapma modalÄ±nÄ± gÃ¶ster
                return;
            }

            const reviewText = document.getElementById('review-text').value.trim();
            // Star rating'in selectedRating deÄŸiÅŸkeni window scope'unda tanÄ±mlÄ± deÄŸil, DOM'dan alÄ±yoruz.
            const ratingElement = document.getElementById('rating-input').querySelector('.rating-star');
            const rating = ratingElement ? parseInt(ratingElement.dataset.rating, 10) : 0;
            const placeId = document.getElementById('detail-modal').dataset.placeId;

            if (!reviewText || !rating || !placeId) {
                alertMessage("LÃ¼tfen hem yorum metnini girin hem de puanÄ±nÄ±zÄ± seÃ§in.", 'bg-yellow-100 border-yellow-400 text-yellow-700');
                return;
            }

            const newReview = {
                placeId: placeId,
                cityId: currentCityId, // Yorum kaydÄ±na ÅŸehir bilgisini de ekle
                userId: auth.currentUser.uid, // GiriÅŸ yapan kullanÄ±cÄ±nÄ±n UID'si
                userName: auth.currentUser.email.split('@')[0], // KullanÄ±cÄ± adÄ± olarak e-postanÄ±n ilk kÄ±smÄ±nÄ± kullan
                rating: rating,
                text: reviewText,
                createdAt: serverTimestamp()
            };

            try {
                // Yorumu kaydet
                const reviewsRef = collection(db, 'artifacts', appId, 'public', 'data', 'reviews');
                await addDoc(reviewsRef, newReview);
                
                document.getElementById('review-text').value = '';
                resetRatingInput();
                alertMessage("Yorumunuz baÅŸarÄ±yla eklendi!", 'bg-green-100 border-green-400 text-green-700');

            } catch (error) {
                console.error("Yorum eklenirken hata oluÅŸtu:", error);
                alertMessage("Yorum eklenirken bir hata oluÅŸtu.", 'bg-red-100 border-red-400 text-red-700');
            }
        };

        // UI iÃ§in yÄ±ldÄ±z puanÄ± seÃ§me iÅŸlevi
        const ratingInput = document.getElementById('rating-input');
        let selectedRating = 0; 
        if(ratingInput) {
            ratingInput.querySelectorAll('svg').forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.rating, 10);
                    updateRatingInput(selectedRating);
                });
                star.addEventListener('mouseover', () => {
                    updateRatingInput(parseInt(star.dataset.rating, 10), true);
                });
                star.addEventListener('mouseout', () => {
                    updateRatingInput(selectedRating);
                });
            });
        }
        
        const updateRatingInput = (rating, isHover = false) => {
            const stars = ratingInput.querySelectorAll('svg');
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating, 10);
                if (starRating <= rating) {
                    star.classList.remove('text-gray-300');
                    star.classList.add('rating-star', 'text-yellow-500'); // hem custom class hem tailwind sarÄ±
                } else {
                    star.classList.remove('rating-star', 'text-yellow-500');
                    star.classList.add('text-gray-300');
                }
            });
            if (!isHover) {
                selectedRating = rating;
            }
        };

        const resetRatingInput = () => {
            selectedRating = 0;
            updateRatingInput(0);
        };

        window.alertMessage = (message, classes) => {
            let alertBox = document.getElementById('custom-alert');

            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = 'custom-alert';
                alertBox.className = 'fixed top-4 right-4 p-3 rounded-lg shadow-xl text-sm transition-opacity duration-300 z-[60] opacity-0';
                document.body.appendChild(alertBox);
            }
            
            alertBox.className = `fixed top-4 right-4 p-3 rounded-lg shadow-xl text-sm transition-opacity duration-300 z-[60] opacity-100 ${classes}`;
            alertBox.textContent = message;

            setTimeout(() => {
                alertBox.classList.remove('opacity-100');
                alertBox.classList.add('opacity-0');
            }, 3000);
        };
    </script>

    <script>
        // --- Mock Data (Sahte Veriler) ---
        
        // Åehir isimlerinin UI'da gÃ¶sterilmesi iÃ§in map
        const CITY_NAMES = {
            'fethiye': 'Fethiye',
            'istanbul': 'Ä°stanbul',
            'izmir': 'Ä°zmir',
            'antalya': 'Antalya',
            'mugla': 'MuÄŸla',
            'ankara': 'Ankara'
        };
        
        // Åehre Ã¶zel UI bileÅŸenleri ve filtre kategorileri
        const CITY_UI_DATA = {
            'fethiye': {
                placeholder: "Ã–rn: Ã–lÃ¼deniz, SaklÄ±kent...",
                categories: ["Plaj", "Antik Kent", "DoÄŸa", "Kanyon", "Tekne Turu"]
            },
            'istanbul': {
                placeholder: "Ã–rn: Galata Kulesi, KapalÄ±Ã§arÅŸÄ±...",
                categories: ["Tarihi YapÄ±", "MÃ¼ze", "Pazar", "Park", "BoÄŸaz Turu"]
            },
            'izmir': {
                placeholder: "Ã–rn: Kordon, Efes, Saat Kulesi...",
                categories: [] // BoÅŸ bÄ±rakÄ±ldÄ±
            },
            // DiÄŸer ÅŸehirler iÃ§in de ekleme yapÄ±labilir.
        };


        // TÃ¼m yerler, ÅŸehir ID'sine gÃ¶re gruplanmÄ±ÅŸ (ArtÄ±rÄ±mlÄ± model iÃ§in esnek yapÄ±)
        const ALL_PLACES = {
            'fethiye': [
                { 
                    id: "oludeniz", 
                    adi: "Ã–lÃ¼deniz (Mavi LagÃ¼n)", 
                    kategori: "Plaj", 
                    puan: 4.8, 
                    yorum_sayisi: 532, 
                    kisa_aciklama: "DÃ¼nyaca Ã¼nlÃ¼, sakin ve turkuaz sularÄ±yla bilinen eÅŸsiz plaj.",
                    detayli_aciklama: "Ã–lÃ¼deniz, adÄ±nÄ± durgun ve sakin sularÄ±ndan alÄ±r; bu da onu yamaÃ§ paraÅŸÃ¼tÃ¼ sonrasÄ±nda gÃ¼venli bir iniÅŸ noktasÄ± ve huzurlu bir yÃ¼zme deneyimi iÃ§in ideal kÄ±lar. BelcekÄ±z PlajÄ± ile bitiÅŸiktir ve milli park statÃ¼sÃ¼ndedir. Ã–zellikle gÃ¼n batÄ±mÄ± manzaralarÄ± kaÃ§Ä±rÄ±lmamalÄ±dÄ±r.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/0d9488/ffffff?text=Turkuaz+OlÃ¼deniz+PlajÄ±"
                },
                { 
                    id: "saklikent", 
                    adi: "SaklÄ±kent Kanyonu", 
                    kategori: "Kanyon", 
                    puan: 4.6, 
                    yorum_sayisi: 415, 
                    kisa_aciklama: "Suyu buz gibi olan, nefes kesici doÄŸal bir kanyon ve macera noktasÄ±.",
                    detayli_aciklama: "20 km uzunluÄŸunda ve 300 metre derinliÄŸe sahip olan SaklÄ±kent, TÃ¼rkiye'nin en bÃ¼yÃ¼k kanyonlarÄ±ndan biridir. Ä°Ã§erideki buz gibi su ve kanyon duvarlarÄ±nÄ±n gÃ¶rkemi, yaz sÄ±caÄŸÄ±nda serinlemek isteyenler iÃ§in unutulmaz bir deneyim sunar. Kanyona girmek iÃ§in su ayakkabÄ±sÄ± ÅŸarttÄ±r.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/10b981/ffffff?text=SaklÄ±kent+Kanyon+Suyu"
                },
                { 
                    id: "kayakoy", 
                    adi: "KayakÃ¶y (TerkedilmiÅŸ Åehir)", 
                    kategori: "Antik Kent", 
                    puan: 4.4, 
                    yorum_sayisi: 289, 
                    kisa_aciklama: "Tarihi ve dramatik hikayesiyle bilinen, terk edilmiÅŸ bir Rum kÃ¶yÃ¼.",
                    detayli_aciklama: "1923 yÄ±lÄ±ndaki nÃ¼fus mÃ¼badelesi sonrasÄ± terk edilen KayakÃ¶y, yÃ¼zlerce taÅŸ ev, iki kilise ve bir okul kalÄ±ntÄ±sÄ±ndan oluÅŸur. Adeta bir hayalet ÅŸehir atmosferi sunan KayakÃ¶y, fotoÄŸrafÃ§Ä±lar ve tarih meraklÄ±larÄ± iÃ§in bÃ¼yÃ¼leyici bir yerdir. Tepeye tÄ±rmanarak Ã–lÃ¼deniz manzarasÄ±nÄ± izleyebilirsiniz.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/6b7280/ffffff?text=KayakÃ¶y+TerkedilmiÅŸ+Evler"
                },
                { 
                    id: "kelebekler_vadisi", 
                    adi: "Kelebekler Vadisi", 
                    kategori: "Plaj", 
                    puan: 4.7, 
                    yorum_sayisi: 350, 
                    kisa_aciklama: "Tekneyle ulaÅŸÄ±lan, endemik bitkileri ve kelebekleriyle Ã¼nlÃ¼ koruma alanÄ±.",
                    detayli_aciklama: "YÃ¼ksek kayalÄ±klarla Ã§evrili, sadece deniz yoluyla ulaÅŸÄ±labilen bu vadi, adÄ±nÄ± barÄ±ndÄ±rdÄ±ÄŸÄ± 80'den fazla kelebek tÃ¼rÃ¼nden alÄ±r. EÅŸsiz doÄŸasÄ± ve berrak deniziyle tam bir cennettir. Vadinin iÃ§ kÄ±smÄ±ndaki ÅŸelaleye kÄ±sa bir tÄ±rmanÄ±ÅŸ yapabilirsiniz.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/374151/ffffff?text=Kelebekler+Vadisi+Tekne"
                },
                { 
                    id: "amintas", 
                    adi: "Amintas Kaya MezarlarÄ±", 
                    kategori: "Antik Kent", 
                    puan: 4.2, 
                    yorum_sayisi: 195, 
                    kisa_aciklama: "Åehrin hemen Ã¼zerinde yer alan, Likya dÃ¶neminden kalma etkileyici mezarlar.",
                    detayli_aciklama: "M.Ã–. 4. yÃ¼zyÄ±la tarihlenen bu anÄ±t mezarlar, Fethiye'nin simgelerindendir. BÃ¼yÃ¼k bir tapÄ±nak cephesi ÅŸeklinde oyulmuÅŸ olan mezar, Likya mimarisinin en gÃ¼zel Ã¶rneklerinden biridir. Åehre ve limana hakim manzarasÄ± gÃ¶rÃ¼lmeye deÄŸerdir.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/f59e0b/ffffff?text=Amintas+Likya+MezarlarÄ±"
                },
                { 
                    id: "calis", 
                    adi: "Ã‡alÄ±ÅŸ PlajÄ±", 
                    kategori: "Plaj", 
                    puan: 4.0, 
                    yorum_sayisi: 150, 
                    kisa_aciklama: "Uzun, kumsal plajÄ± ve muhteÅŸem gÃ¼n batÄ±mÄ± manzaralarÄ± ile popÃ¼ler.",
                    detayli_aciklama: "Fethiye merkezine en yakÄ±n plajlardan biri olan Ã‡alÄ±ÅŸ, Ã¶zellikle rÃ¼zgar sÃ¶rfÃ¼ ve diÄŸer su sporlarÄ± iÃ§in idealdir. Deniz kaplumbaÄŸalarÄ±nÄ±n (Caretta Caretta) yumurtlama alanÄ±dÄ±r ve burada gÃ¼n batÄ±mÄ±nÄ± izlemek bir gelenektir.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/22c55e/ffffff?text=Ã‡alÄ±ÅŸ+PlajÄ±+GÃ¼nbatÄ±mÄ±"
                },
            ],
            'istanbul': [
                {
                    id: "ayasofya",
                    adi: "Ayasofya-i Kebir Camii",
                    kategori: "Tarihi YapÄ±",
                    puan: 4.9,
                    yorum_sayisi: 980,
                    kisa_aciklama: "Bin yÄ±lÄ± aÅŸkÄ±n sÃ¼redir ayakta duran, dÃ¼nyanÄ±n sekizinci harikasÄ± kabul edilen gÃ¶rkemli yapÄ±.",
                    detayli_aciklama: "Ayasofya, Bizans ve OsmanlÄ± Ä°mparatorluklarÄ± dÃ¶neminde kilise ve cami olarak hizmet vermiÅŸ, mimari ve tarihi aÃ§Ä±dan benzersiz bir yapÄ±dÄ±r. YÃ¼ksek kubbesi, mozaikleri ve devasa boyutlarÄ±yla ziyaretÃ§ilerini bÃ¼yÃ¼lemektedir. Sultanahmet MeydanÄ±'nÄ±n hemen karÅŸÄ±sÄ±nda bulunur.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/581c87/ffffff?text=Ayasofya+DÄ±ÅŸ+GÃ¶rÃ¼nÃ¼m"
                },
                {
                    id: "galata",
                    adi: "Galata Kulesi",
                    kategori: "Tarihi YapÄ±",
                    puan: 4.7,
                    yorum_sayisi: 720,
                    kisa_aciklama: "Tarihi Ceneviz kulesi. Åehrin en iyi panoramik manzarasÄ±nÄ± sunar.",
                    detayli_aciklama: "14. yÃ¼zyÄ±lda inÅŸa edilen Galata Kulesi, HaliÃ§ ve BoÄŸaz'Ä± kuÅŸ bakÄ±ÅŸÄ± izlemek iÃ§in en popÃ¼ler yerdir. Ä°stanbul'un simgelerinden biri olan kule, Ã¶zellikle gÃ¼n batÄ±mÄ±nda turist akÄ±nÄ±na uÄŸrar. Ã‡evresindeki sokaklar kafeler ve butiklerle doludur.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/7c3aed/ffffff?text=Galata+Kulesi+PanoramasÄ±"
                },
                {
                    id: "kapalicarsi",
                    adi: "KapalÄ±Ã§arÅŸÄ± (Grand Bazaar)",
                    kategori: "Pazar",
                    puan: 4.5,
                    yorum_sayisi: 650,
                    kisa_aciklama: "DÃ¼nyanÄ±n en bÃ¼yÃ¼k ve en eski kapalÄ± pazarlarÄ±ndan biri.",
                    detayli_aciklama: "Labirent gibi koridorlarÄ±, binlerce dÃ¼kkanÄ± ve renkli atmosferiyle KapalÄ±Ã§arÅŸÄ±, alÄ±ÅŸveriÅŸ ve kÃ¼ltÃ¼rel bir deneyim sunar. AltÄ±n takÄ±lar, halÄ±lar, seramikler ve baharatlar bulabilirsiniz. BurasÄ± sadece bir pazar deÄŸil, aynÄ± zamanda tarihi bir yapÄ±dÄ±r.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/ef4444/ffffff?text=KapalÄ±Ã§arÅŸÄ±+Ä°Ã§+GÃ¶rÃ¼nÃ¼m"
                },
                {
                    id: "topkapi",
                    adi: "TopkapÄ± SarayÄ± MÃ¼zesi",
                    kategori: "MÃ¼ze",
                    puan: 4.6,
                    yorum_sayisi: 590,
                    kisa_aciklama: "OsmanlÄ± Ä°mparatorluÄŸu'nun yÃ¼zyÄ±llarca idare edildiÄŸi gÃ¶rkemli saray.",
                    detayli_aciklama: "TopkapÄ± SarayÄ±, HaliÃ§, BoÄŸaz ve Marmara Denizi'ne hakim konumuyla, OsmanlÄ± padiÅŸahlarÄ±nÄ±n yaÅŸam sÃ¼rdÃ¼ÄŸÃ¼ ve devleti yÃ¶nettiÄŸi yerdir. Harem, kutsal emanetler, porselenler ve el yazmalarÄ± koleksiyonlarÄ±yla Ã¼nlÃ¼dÃ¼r. SarayÄ±n bahÃ§eleri huzur doludur.",
                    // GÃ¶rseli gÃ¼ncelledik:
                    resim_url: "https://placehold.co/800x600/f97316/ffffff?text=TopkapÄ±+Saray+KapÄ±sÄ±"
                }
            ],
            'izmir': [],
            'antalya': [],
            'mugla': [],
            'ankara': []
        };
        
        // UygulamanÄ±n anlÄ±k olarak hangi ÅŸehirde olduÄŸunu tutar
        let currentCityId = 'fethiye'; 
        let currentPlaceId = null;

        /**
         * PuanÄ± temsil eden yÄ±ldÄ±z SVG'lerini oluÅŸturur.
         * @param {number} rating Puan (1-5 arasÄ±)
         * @returns {string} HTML string of stars
         */
        function generateStarRating(rating) {
            const fullStar = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 rating-star" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.031a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.031a1 1 0 00-1.175 0l-2.817 2.031c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
            const emptyStar = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-300" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.817 2.031a1 1 0 00-.363 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.817-2.031a1 1 0 00-1.175 0l-2.817 2.031c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>';
            
            let stars = '';
            const fullStars = Math.floor(rating);
            const remainder = rating % 1; 

            for (let i = 0; i < fullStars; i++) {
                stars += fullStar;
            }

            if (remainder > 0.3) {
                stars += fullStar; 
            }

            const totalStars = 5;
            const filledStars = stars.match(/<svg/g) ? stars.match(/<svg/g).length : 0;
            for (let i = filledStars; i < totalStars; i++) {
                stars += emptyStar;
            }

            return stars;
        }

        /**
         * Åehir seÃ§im kartlarÄ±nÄ± modal iÃ§ine render eder.
         */
        function renderCitySelectionGrid() {
            const container = document.getElementById('city-selection-grid');
            container.innerHTML = '';
            
            // TÃ¼m ÅŸehirleri dolaÅŸ
            Object.keys(CITY_NAMES).forEach(cityId => {
                const cityName = CITY_NAMES[cityId];
                // Fethiye ve Ä°stanbul'u aktif hale getir
                const isActive = cityId === 'fethiye' || cityId === 'istanbul'; 
                const isDisabled = !isActive;

                const card = document.createElement('div');
                card.className = `city-card rounded-xl border border-gray-200 p-6 text-center shadow-lg ${isDisabled ? 'disabled' : 'cursor-pointer hover:border-teal-600'}`;
                
                if (isActive) {
                    card.onclick = () => selectCity(cityId);
                }

                card.innerHTML = `
                    <div class="h-16 w-16 mx-auto mb-3 bg-teal-100 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 mb-1">${cityName}</h4>
                    <p class="text-sm text-gray-500">${isActive ? 'Aktif' : 'YakÄ±nda Eklenecek'}</p>
                `;
                container.appendChild(card);
            });
        }

        /**
         * Arama Ã§ubuÄŸu placeholder'Ä± ve kategori filtrelerini gÃ¼nceller.
         * @param {string} cityId
         */
        function updateSearchAndFilters(cityId) {
            const uiData = CITY_UI_DATA[cityId];
            const categoryFilter = document.getElementById('category-filter');
            const searchInput = document.getElementById('search-input');
            
            // 1. Arama Ä°pucunu GÃ¼ncelle
            searchInput.placeholder = uiData.placeholder || "KeÅŸfedilecek yerleri arayÄ±n...";

            // 2. Kategori Filtresini GÃ¼ncelle
            categoryFilter.innerHTML = '<option value="TÃ¼mÃ¼">TÃ¼m Kategoriler</option>'; // Filtreyi sÄ±fÄ±rla
            
            if (uiData.categories) {
                uiData.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    categoryFilter.appendChild(option);
                });
            }

            // 3. Filtreleri sÄ±fÄ±rla ve listeyi yeniden yÃ¼kle
            searchInput.value = '';
            filterPlaces();
        }

        /**
         * KullanÄ±cÄ±nÄ±n ÅŸehir seÃ§imini yapar ve ana arayÃ¼zÃ¼ gÃ¶sterir.
         * @param {string} cityId SeÃ§ilen ÅŸehrin ID'si.
         */
        window.selectCity = function(cityId) {
            currentCityId = cityId;

            // UI'Ä± gÃ¶ster
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('main-footer').classList.remove('hidden');
            document.getElementById('city-selection-modal').classList.add('hidden');

            // BaÅŸlÄ±klarÄ± ve iÃ§eriÄŸi gÃ¼ncelle
            const cityName = CITY_NAMES[cityId] || 'Bilinmiyor';
            document.getElementById('current-city-display').textContent = cityName;
            document.getElementById('search-bar-title').textContent = `${cityName}'de Nereyi KeÅŸfetmek Ä°stersiniz?`;
            
            // YENÄ°: Arama ve filtreleri ÅŸehre gÃ¶re gÃ¼ncelle
            updateSearchAndFilters(cityId);

            closeModal(); // ModalÄ± kapat (eÄŸer aÃ§Ä±ksa)
        }
        
        /**
         * Åehir seÃ§im modalÄ±nÄ± gÃ¶sterir (Header'daki butondan Ã§aÄŸrÄ±lÄ±r)
         */
        window.showCitySelectionModal = function() {
            document.getElementById('city-selection-modal').classList.remove('hidden');
            // Ana iÃ§eriÄŸi ve baÅŸlÄ±ÄŸÄ± gizle
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('main-footer').classList.add('hidden');
        }


        /**
         * Verilen yer listesini arayÃ¼ze render eder.
         * @param {Array<Object>} places 
         */
        function renderPlaceList(places) {
            const container = document.getElementById('place-list-section');
            container.innerHTML = ''; 
            
            // Seyahat planÄ± butonunu etkinleÅŸtir/pasifleÅŸtir
            document.getElementById('plan-button').disabled = places.length === 0;


            if (places.length === 0) {
                const cityName = CITY_NAMES[currentCityId] || 'Bu Åehir';
                container.innerHTML = `<p class="text-center text-gray-500 col-span-full py-8 text-lg">
                    Åu an sadece Fethiye ve Ä°stanbul verileri mevcuttur. <b>${cityName}</b> iÃ§in yerler yakÄ±nda eklenecektir.
                </p>`;
                return;
            }

            places.forEach(place => {
                const card = document.createElement('div');
                card.className = 'place-card bg-white rounded-xl shadow-lg overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300';
                card.onclick = () => showPlaceDetail(place.id);
                
                card.innerHTML = `
                    <img src="${place.resim_url}" alt="${place.adi}" class="w-full h-48 object-cover">
                    <div class="p-5">
                        <span class="inline-block bg-teal-100 text-teal-800 text-xs font-medium px-3 py-1 rounded-full mb-3">${place.kategori}</span>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">${place.adi}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-2">${place.kisa_aciklama}</p>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-1">
                                ${generateStarRating(place.puan)}
                                <span class="text-sm font-semibold text-gray-800 ml-2">${place.puan.toFixed(1)}</span>
                                <span class="text-xs text-gray-500">(${place.yorum_sayisi} yorum)</span>
                            </div>
                            <span class="text-sm font-medium text-teal-600 hover:text-teal-800">DetaylarÄ± GÃ¶r &rarr;</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        /**
         * SeÃ§ilen ÅŸehri deÄŸiÅŸtirir ve arayÃ¼zÃ¼ gÃ¼nceller.
         * @param {string} cityId Yeni ÅŸehir ID'si.
         */
        window.changeCity = function(cityId) {
            currentCityId = cityId;

            // UI gÃ¼ncellemeleri
            const cityName = CITY_NAMES[cityId] || 'Bilinmiyor';
            document.getElementById('current-city-display').textContent = cityName;
            document.getElementById('search-bar-title').textContent = `${cityName}'de Nereyi KeÅŸfetmek Ä°stersiniz?`;
            
            // Arama/Filtre alanlarÄ±nÄ± temizle ve yeniden yÃ¼kle
            updateSearchAndFilters(cityId);

            closeModal(); // ModalÄ± kapat (eÄŸer aÃ§Ä±ksa)
        }

        /**
         * Arama ve kategoriye gÃ¶re listeyi filtreler.
         */
        window.filterPlaces = function() {
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const categoryFilter = document.getElementById('category-filter').value;
            
            // Veriyi mevcut ÅŸehirden al
            const currentPlaces = ALL_PLACES[currentCityId] || [];

            const filtered = currentPlaces.filter(place => {
                const matchesSearch = place.adi.toLowerCase().includes(searchInput) || 
                                      place.kisa_aciklama.toLowerCase().includes(searchInput);
                
                const matchesCategory = categoryFilter === 'TÃ¼mÃ¼' || place.kategori === categoryFilter;

                return matchesSearch && matchesCategory;
            });

            renderPlaceList(filtered);
        }

        /**
         * Detay modalÄ±nÄ± aÃ§ar ve ilgili yerin bilgilerini doldurur.
         * @param {string} id 
         */
        function showPlaceDetail(id) {
            const currentPlaces = ALL_PLACES[currentCityId] || [];
            const place = currentPlaces.find(p => p.id === id);
            if (!place) return;

            // Modal'Ä± doldur
            document.getElementById('detail-modal').dataset.placeId = id;
            document.getElementById('detail-title').textContent = place.adi;
            document.getElementById('detail-image').src = place.resim_url;
            document.getElementById('detail-image').alt = place.adi;
            // AÃ§Ä±klamayÄ± sÄ±fÄ±rla ve orijinal metni koy
            document.getElementById('detail-description').textContent = place.detayli_aciklama;
            
            // Ã–zet butonunu sÄ±fÄ±rla
            document.getElementById('summary-button').textContent = 'âœ¨ AÃ§Ä±klamayÄ± Ã–zetle';
            document.getElementById('summary-button').disabled = false;
            document.getElementById('tts-button').textContent = 'ğŸ”Š Dinle';
            document.getElementById('tts-button').disabled = false;

            // Puan ve yÄ±ldÄ±zlarÄ± doldur
            document.getElementById('detail-rating-container').innerHTML = `
                <span class="text-2xl font-bold text-gray-900">${place.puan.toFixed(1)}</span>
                <div class="flex items-center space-x-0.5">
                    ${generateStarRating(place.puan)}
                </div>
                <span class="text-sm text-gray-500">(${place.yorum_sayisi} yorum)</span>
            `;

            // Harita placeholder'Ä±nÄ± gÃ¼ncelle
            document.getElementById('detail-map').innerHTML = `<p class="italic">Konum: ${place.adi} (Harita entegrasyonu aÅŸama 2'de eklenecektir.)</p>`;
            
            // YorumlarÄ± dinle/yÃ¼kle (Firebase entegre ise)
            if (typeof listenForReviews !== 'undefined') {
                listenForReviews(id);
            } else {
                // Firebase yoksa sahte yorum gÃ¶ster
                document.getElementById('review-count').textContent = '0 (Sahte)';
                document.getElementById('reviews-container').innerHTML = `<p class="text-gray-500">Bu bir MVP'dir. GerÃ§ek yorumlar Firebase entegrasyonu sonrasÄ± gÃ¶rÃ¼nÃ¼r olacaktÄ±r.</p>`;
            }

            // ModalÄ± gÃ¶ster
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-modal').classList.add('flex');
        }

        /**
         * Detay modalÄ±nÄ± kapatÄ±r.
         */
        window.closeModal = function() {
            document.getElementById('detail-modal').classList.add('hidden');
            document.getElementById('detail-modal').classList.remove('flex');
            // Ã‡almakta olan sesi durdur
            const existingAudio = document.getElementById('place-audio');
            if (existingAudio) {
                existingAudio.pause();
                existingAudio.remove();
            }

            if (typeof resetRatingInput !== 'undefined') {
                resetRatingInput(); 
            }
        }

        /**
         * Uygulama baÅŸlangÄ±cÄ±nda Ã§alÄ±ÅŸacak ana fonksiyon.
         */
        window.loadData = function() {
            renderCitySelectionGrid(); // Åehir seÃ§im ekranÄ±nÄ± hazÄ±rla
            // Bu kÄ±sÄ±m sayfa yÃ¼klendiÄŸinde otomatik Fethiye'yi seÃ§mek iÃ§in kullanÄ±lÄ±r.
            selectCity(currentCityId);
        };

        // EÄŸer Firebase baÅŸlatÄ±lmazsa (config yoksa), verileri direkt yÃ¼kle.
        // Firebase varsa, yÃ¼kleme iÅŸlemi onAuthStateChanged iÃ§inde tetiklenir.
        if (typeof isAuthReady !== 'undefined' && isAuthReady) {
             window.loadData();
        }

        // ModalÄ± ESC tuÅŸu ile kapatma
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeTripPlanModal();
                closeAuthModal(); // Yeni: Auth modalÄ±nÄ± da kapat
            }
        });
        
        // ModalÄ± dÄ±ÅŸarÄ± tÄ±klayarak kapatma
        document.getElementById('detail-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'detail-modal') {
                closeModal();
            }
        });
        document.getElementById('trip-plan-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'trip-plan-modal') {
                closeTripPlanModal();
            }
        });
        document.getElementById('auth-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'auth-modal') {
                closeAuthModal();
            }
        });
        
        // Uygulama ilk yÃ¼klendiÄŸinde Fethiye'yi seÃ§ili hale getir ve ana iÃ§eriÄŸi gÃ¶ster (BaÅŸlangÄ±Ã§ AkÄ±ÅŸÄ±)
        window.onload = function() {
            renderCitySelectionGrid();
            selectCity(currentCityId);
            
            if (typeof isAuthReady !== 'undefined' && isAuthReady) {
                document.getElementById('city-selection-modal').classList.add('hidden');
            }
        };

    </script>
</body>
</html>